# **DBT Design**

## **1\. dbt Conventions**

To ensure consistency, discoverability, and reliable automation across environments, all dbt models follow strict naming and tagging conventions:

### Naming Conventions

- **Bronze models**: Prefix with `bronze_` (e.g., `bronze_orders`, `bronze_customers`)  
- **Silver models**: Prefix with `silver_` (e.g., `silver_orders_enriched`)  
- **Gold models**: Prefix with `gold_` (e.g., `gold_sales_summary`)

This ensures that even when schema context is lost (e.g., cross-schema queries, exports to Fabric/Power BI), model lineage is immediately clear.

### Schema Conventions

- **Bronze models**: Deployed to schema `bronze`  
- **Silver models**: Deployed to schema `silver`  
- **Gold models**: Deployed to schema `gold`

Schemas \+ prefixes together ensure redundancy and future-proofing for domain-level extensions (e.g., `bronze_marketing`, `gold_finance`).

### Tagging Conventions

- **Bronze models**: `tags: ["bronze"]`  
- **Silver models**: `tags: ["silver"]`  
- **Gold models**: `tags: ["gold"]`  
- **Domain-specific tags** may be added (e.g., `["bronze", "sales"]`)

Tags are used by:

- Cosmos DAGs to determine execution order.  
- CI/CD pipelines to selectively run/validate subsets of models.  
- Observability tooling for lineage, cost, and performance reporting.

### File & Folder Conventions

- `models/bronze/bronze_{source_table}.sql`  
- `models/silver/silver_{business_entity}.sql`  
- `models/gold/gold_{analytical_output}.sql`

All autogenerated Bronze models are stored in:

- `models/bronze/generated/`

### Macros

- Platform-provided macros: `/macros/platform/` (do not modify).  
- Client-authored macros: `/macros/custom/`.  
- Macros must be documented with parameters, defaults, and examples.

### Example

```
version: 2

models:
  - name: bronze_orders
    description: "Raw orders ingested from Shopify"
    tags: ["bronze", "shopify"]
    columns:
      - name: order_id
        tests:
          - not_null
          - unique
```

### Platform-Provided Test Macros

Platform provides standardized test macros in `/macros/platform/` that ensure data quality across Bronze ingestion:

- **`test_bronze_integrity()`** \- Validates all ETL control columns (`_integration_key`, `_ingestion_timestamp`, `_update_timestamp`, `_job_run_id`) exist and are populated  
- **`test_watermark_progression()`** \- Ensures `_ingestion_timestamp` is monotonically increasing for incremental loads  
- **`test_integration_key_valid()`** \- Validates `_integration_key` format and ensures no null placeholders

These macros are:

- Platform-managed (do not modify)  
- Automatically applied to Bronze models during CI generation  
- Available for customer reuse in Silver/Gold models via `{{ test_bronze_integrity(model_name) }}`

## **2\. dbt Configuration**

dbt configuration is split into two parts: **profiles** and the **project definition**.

### **Bootstrap from Service Central**

- A **golden baseline** of `profiles.yml` and `dbt_project.yml` is maintained in the **Service Central Repository**.  
- These files contain hardcoded defaults for environment variables, schema conventions, and basic project configuration.  
- During onboarding (see *Customer Onboarding Design*), the baseline files are deployed into the tenant repo.  
- From this point forward:  
  - The **tenant repo owns the files**.  
  - All updates are managed through the tenant’s standard Git workflow (branch, PR, review).  
  - The Service Central repo is not responsible for lifecycle management once deployed.

### **Profiles**

- `profiles.yml` is delivered pre-populated with default connection parameters and environment placeholders.  
- Tenants are expected to update these values post-deployment to reference their specific Key Vault secrets, tokens, and schema names.  
- Secrets should never be committed directly; they are referenced as Key Vault secret names or as environment variable placeholders.  
- Governance checks (see *Governance Design*) ensure no plaintext secrets are added in PRs.

### **Project Configuration**

- `dbt_project.yml` is provided with:  
  - Default folder paths for models, seeds, snapshots, and tests.  
  - Default `vars` to establish schema naming conventions and environment identifiers.  
- Tenants extend and modify this file as needed for their transformations, subject to governance rules.

### **Parameter Source of Truth**

- **Day-1 Bootstrap**: Service Central repo provides baseline files (`profiles.yml`, `dbt_project.yml`).  
- **Ongoing Management**: Tenants maintain these files in their repo.  
- **Secrets**: Always resolved at runtime from Key Vault, not stored in git.  
- **Non-secrets**: Versioned in tenant repo under Git governance.

### **Governance**

- PR reviews enforce that:  
  - No secrets are committed.  
  - Schema conventions are adhered to.  
  - Changes to `profiles.yml` and `dbt_project.yml` follow the branching and approval policy defined in *Governance Design*.  
- CI/CD pipelines fail fast if required parameters (e.g., `DBT_TOKEN`, `DBT_HOST`) are missing. Validation and deployment workflows for dbt configs (lint, parse, compile, run) are covered in *CI/CD Design* (Workflow A–H). DBT Design assumes those workflows will generate and validate configs as part of the standard pipeline.

